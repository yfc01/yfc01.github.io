---
title: "STM32定时器" #标题
date: 2024-12-22T23:38:26+08:00 #创建时间
lastmod: 2024-12-22T23:38:26+08:00 #更新时间
author: ["yfc01"] #作者
categories: 
- embedded
tags: 
- STM32定时器
description: "TM32定时器介绍" #描述
weight: # 输入1可以顶置文章，用来给文章展示排序，不填就默认按时间排序
slug: "STM32 Timer"
draft: false # 是否为草稿
comments: true #是否展示评论
showToc: true # 显示目录
TocOpen: true # 自动展开目录
hidemeta: false # 是否隐藏文章的元信息，如发布日期、作者等
disableShare: true # 底部不显示分享栏
showbreadcrumbs: false #顶部显示当前路径
cover:
    image: "" #图片路径：posts/tech/文章1/picture.png
    caption: "" #图片底部描述
    alt: ""
    relative: false
---

## 前言

关于定时器的相关笔记内容在很早之前就已完成，只是恰好最近又使用到了相关知识，于是把之前的笔记重新整理了一遍上传到了博客。

## TIM简介

- 定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断。
- 16位计数器、预分频器、自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65s的定时。
- 不仅具备基本的定时中断功能，而且还包含内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等多种功能。
- 根据复杂度和应用场景分为了高级定时器、通用定时器、基本定时器三种类型。

## STM32定时器类型

| **类型**   | **编号**               | **总线** | **功能**                                                     |
| ---------- | ---------------------- | -------- | ------------------------------------------------------------ |
| 高级定时器 | TIM1、TIM8             | APB2     | 拥有通用定时器全部功能，并额外具有重复计数器、死区生成、互补输出、刹车输入等功能 |
| 通用定时器 | TIM2、TIM3、TIM4、TIM5 | APB1     | 拥有基本定时器全部功能，并额外具有内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等功能 |
| 基本定时器 | TIM6、TIM7             | APB1     | 拥有定时中断、主模式触发DAC的功能                            |

## STM32基本定时器

基本定时器分为三部分：

1. 时钟源
2. 控制器
3. 时基单元

<img src="https://i.postimg.cc/DzSx9Gz2/image.png" alt="Image" data-zoomable width="80%;">

1. **时钟源**：时钟源来自RCC的TIMXCLK，就是内部时钟（CK_INT）直接经过控制器传给时基单元充当CK_PSC
2. **控制器**：控制定时器的复位、使能、计数、DAC触发
3. **时基单元**
   1. 预分频器:分频、得到计时器的时钟，即CNT计数1次所需要的时间,预分频器时16位的寄存器、所以可分频为1-65536
   2. 计数器：用来计数
   3. 自动装载寄存器ARR：即CNT加到ARR的值之后，会产生一个事件或中断或DMA请求
   4. 时基单元里面还有非常重要的寄存器——影子寄存器，什么是影子寄存器呢？仔细看上面的图会发现PSC和自动重装载寄存器ARR都有阴影，它们就是影子寄存器。影子寄存器的作用：PSC和ARR都是当影子寄存器被写入新的值时，电路才会生效，所以是用户值->寄存器->影子寄存器->生效，影子寄存器可以起到缓冲的作用。

<img src="https://i.postimg.cc/vTh7g8mq/image.png" alt="Image" data-zoomable width="80%;">

## STM32通用定时器

**STM32的通用定时器是由一个可编程预分频器（PSC）驱动的16位自动重装载计数器（CNT）构成，可用于测量输入脉冲长度（输入捕获）或者产生输出波形（输出比较和PWM）等。**

STM3 的通用TIMx（TIM2、TIM3、TIM4 和 TIM5）定时器功能特点包括：

- **位于低速的APB1总线上（注意：高级定时器是在高速的APB2总线上）**；
- **16位向上、向下、向上/向下（中心对齐）计数模式**，自动装载计数器（TIMx_CNT）；
- **16位**可编程（可以实时修改）预分频器（TIMx_PSC）**，计数器时钟频率的分频系数 为 1～65535 之间的任意数值；**
- **4 个独立通道（TIMx_CH1~4）**，这些通道可以用来作为：
  1. 输入捕获
  2. 输出比较
  3. PWM生成（边缘或中间对齐模式）
  4. 单脉冲模式输出 

- 可使用外部信号（TIMx_ETR）**控制定时器和定时器互连**（可以用 1 个定时器控制另外一个定时器）的同步电路。
- 如下事件发生时产生中断/DMA（**6个独立的IRQ/DMA请求生成器**）：
  1. **更新：计数器向上溢出/向下溢出，计数器初始化(通过软件或者内部/外部触发)** 
  2. **触发事件（计数器启动、停止、初始化或者由内部/外部触发计数）**
  3. **输入捕获** 
  4. **输出比较** 
  5. 支持针对定位的增量（正交）编码器和霍尔传感器电路 
  6. 触发输入作为外部时钟或者按周期的电流管理

STM32 的通用定时器可以被用于：测量输入信号的脉冲长度（输入捕获）或者产生输出波形（输出比较和 PWM）等。 

使用定时器预分频器和 RCC 时钟控制器预分频器，脉冲长度和波形周期可以在几个微秒到几个毫秒间调整。**STM32 的每个通用定时器都是完全独立的，没有互相共享的任何资源。**

### 计数器模式

通用定时器可以向上计数、向下计数、向上向下双向计数模式。

- 向上计数模式：计数器从**0计数到自动加载值（TIMx_ARR）**，然后重新从0开始计数并且产生一个计数器溢出事件。
- 向下计数模式：计数器从**自动装入的值（TIMx_ARR）开始向下计数到0**，然后从自动装入的值重新开始，并产生一个计数器向下溢出事件。
- 中央对齐模式（向上/向下计数）：**计数器从0开始计数到自动装入的值-1，产生一个计数器溢出事件，然后向下计数到1并且产生一个计数器溢出事件；然后再从0开始重新计数**。

简单地理解三种计数模式，可以通过下面的图形：

<img src="https://i.postimg.cc/T3fwNjCD/image.png" alt="Image" data-zoomable width="80%;">



### 通用定时器结构

<img src="https://i.postimg.cc/Pq3VRjn8/image.png" alt="Image" data-zoomable width="80%;">

对于这个定时器框图，分成四部分来讲：最顶上的一部分（**计数时钟的选择**）、中间部分（**时基单元**）、左下部分（**输入捕获**）、右下部分（**PWM输出**）。

#### 计数时钟的选择

| 时钟源                                      | 说明                                                         | 适用场景                                                     |
| ------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **内部时钟（TIMx_CLK）**                    | 定时器的时钟源通常来自系统时钟（如 APB 总线时钟）。时钟周期由定时器的预分频器决定。 | 一般应用，适用于不需要外部时钟源的情况。                     |
| **外部时钟模式1：外部捕捉比较引脚（TIx）**  | 使用外部输入信号（例如：外部传感器信号）作为计数源，通过捕捉或比较引脚（TIx）提供时钟。 | 用于外部事件触发计时，应用于例如计量或脉冲输入的情况。       |
| **外部时钟模式2：外部引脚输入（TIMx_ETR）** | 定时器可以通过外部事件触发输入（ETR）引脚接收时钟信号，这适合于接收外部设备提供的时钟信号。 | 当需要精确同步外部信号或时钟时，常用于同步外部设备。         |
| **内部触发输入（ITRx）**                    | 一个定时器可以作为另一个定时器的预分频器，利用触发输入（ITRx）来共享时钟源。 | 用于需要多个定时器协同工作时，能够提高同步精度，减少硬件需求。 |

#### 时基单元

可查看上述基础定时器部分内容。

#### 输入捕获

输入捕获模式将一个外部信号引脚连接到定时器输入捕获通道，通过定时器的输入捕获寄存器（CCR）记录信号的边沿事件（上升沿或下降沿）发生时定时器的计数值。通过比较这些计数值，可以计算出输入信号的周期、频率或占空比等特性。主要特性：

- **边沿选择**：可以选择在上升沿、下降沿或两者都捕获。
- **多通道支持**：一个定时器通常支持多个输入捕获通道，每个通道都有独立的捕获寄存器。
- **中断与DMA支持**：捕获事件可以触发中断或通过DMA传输数据。

#### PWM输出

PWM（Pulse Width Modulation，脉冲宽度调制）是一种通过调节脉冲信号的占空比（即高电平时间相对于周期的比例）来控制功率输出的方法。PWM广泛应用于电机控制、LED调光、音频信号生成等领域。在STM32微控制器中，定时器可以用来生成PWM信号。PWM输出原理：

PWM信号是一种方波信号，其占空比可以调节。通过改变信号的占空比，可以控制负载（如电机、LED等）接收到的平均功率。例如：

- **100%占空比**：信号始终为高电平，负载接收最大功率。
- **50%占空比**：信号一半时间为高电平，一半时间为低电平，负载接收50%的功率。
- **0%占空比**：信号始终为低电平，负载接收最小功率。

## STM32高级定时器

高级定时器适用于需要精确控制和复杂功能的应用场景，而低级定时器则适用于简单的定时和延时任务。选择哪种定时器取决于具体应用的需求。

<img src="https://i.postimg.cc/yY2V2MBt/6-1.png" alt="Image" data-zoomable width="80%;">

高级定时器相较于普通定时器，升级了如图数字所示部分：

- 重复次数计数器：增加计数器的计数能力。
- DTG：死区生成电路
- 互补的PWM输出
- 时钟安全系统

### 重复次数计数器

- **功能**：重复次数计数器（也叫做循环计数器）用于增加定时器的计数能力，通常与 PWM 输出相关。当 PWM 信号输出需要进行多次重复或产生复杂的波形时，重复次数计数器允许定时器在一个周期内生成多次信号。
- **使用场景**：
  - 在需要生成较长周期或较复杂周期波形的应用中，例如用于电机控制、步进电机的精准控制等。
  - 该计数器通常与基本定时器或高级定时器结合使用，提升计数范围和分辨率。
- **原理**：重复计数器增加了定时器周期的重复次数，用户可以配置一个基本周期内的重复计数，提升信号的灵活性和稳定性。

### DTG：死区生成电路

- **功能**：死区生成电路（DTG）用于在互补 PWM 输出信号之间生成一个“死区”时间，即两个输出信号之间存在一个延迟，避免由于开关延迟造成的电流冲突。
- **使用场景**：
  - 主要应用于电机驱动、H 桥电路或其他需要互补输出的电力电子应用中。
  - 通过引入死区时间，可以防止上、下桥臂同时导通，避免短路，保护电路免受损坏。
- **原理**：DTG 控制 PWM 输出的两个信号之间的时间间隔。在该死区时间内，两个信号都保持不输出或处于关闭状态，确保在高压负载时，两个输出不会发生冲突。

### 互补的 PWM 输出

- **功能**：互补 PWM 输出通常用于需要两个互补信号的应用场景，例如电机控制、H 桥驱动电路等。互补 PWM 输出会生成两个 PWM 信号，其中一个信号与另一个信号相反。
- **使用场景**：
  - 常用于驱动 H 桥、全桥电路、双极电机驱动等，其中要求两个信号保持一定的反向关系来控制负载的正负极。
  - 适用于需要精确控制开关元件的电力电子应用，如 DC 电机控制、步进电机控制等。
- **原理**：互补 PWM 输出生成两个频率相同、但相位相反的信号。这样在电机控制中，两个信号能够在不同的桥臂中交替切换，产生旋转磁场，驱动电机转动。

### 时钟安全系统

- **功能**：时钟安全系统用于监控系统时钟源的状态，确保系统时钟的稳定性。若主时钟源（如外部晶振或内部分频器）发生故障或失效时，系统能够切换到备用时钟源，避免系统因时钟源问题而出现崩溃。
- **使用场景**：
  - 在工业控制、汽车电子、通信系统等要求高可靠性的应用中，时钟的稳定性至关重要。
  - 特别适用于对时钟可靠性有高要求的系统，如需要长时间稳定运行的嵌入式系统。
- **原理**：时钟安全系统监控主时钟源的健康状态，一旦检测到时钟源异常（如晶振故障），系统会自动切换到备用时钟源（通常是内部振荡器）以确保系统持续运行。

## 定时器中断基本结构

<img src="https://i.postimg.cc/grFTHHFS/image.png" alt="Image" data-zoomable width="80%;">



## 时基单元时序

### 预分频器时序

<img src="https://i.postimg.cc/Y2Rc1JhY/image.png" alt="Image" data-zoomable width="80%;">

计数器计数频率：CK_CNT = CK_PSC / (PSC + 1)

**CK_PSC**：这是定时器预分频器的输入时钟频率。通常，CK_PSC 是系统时钟频率或者一个已知的固定频率。

**PSC**：这是预分频器寄存器的值。它是一个可以配置的整数，用于设置定时器的预分频比。

**CK_CNT**：这是定时器计数器的时钟频率。经过预分频器后，定时器实际工作的时钟频率。

### 计数器时序

<img src="https://i.postimg.cc/HxtN9ysd/image.png" alt="Image" data-zoomable width="80%;">

计数器溢出频率：CK_CNT_OV = CK_CNT / (ARR + 1) = CK_PSC / (PSC + 1) / (ARR + 1)

**CK_PSC**：这是定时器预分频器的输入时钟频率，通常为系统时钟频率或其他已知固定频率。

**PSC**：这是预分频器寄存器的值，用于设置定时器的预分频比。

**CK_CNT**：这是定时器计数器的时钟频率。

**ARR**：这是自动重装载寄存器（Auto-Reload Register）的值。定时器计数到该值后，会发生溢出并重新开始计数。

**CK_CNT_OV**：这是定时器计数器溢出的频率。

### 计数器无预装时序

<img src="https://i.postimg.cc/RVsVtHxB/image.png" alt="Image" data-zoomable width="80%;">

没有缓冲寄存器，在更改计数器数值的时候会直接改变计数器的计数值。

### 计数器有预装时序

<img src="https://i.postimg.cc/JhJ1SYDr/image.png" alt="Image" data-zoomable width="80%;">

有缓冲寄存器，在更改计数器数值的时候不会直接改变计数器的计数值，需要本次计数周期完成才会更改计数器计数值。

## RCC时钟树

什么是时钟？

**时钟是单片机运行的基础，时钟信号推动单片机内各个部分执行相应的指令**。时钟系统就是CPU的脉搏，决定cpu速率，像人的心跳一样 只有有了心跳，人才能做其他的事情，而单片机有了时钟，才能够运行执行指令，才能够做其他的处理 (点灯，串口，ADC)，时钟的重要性不言而喻。

为什么 STM32 要有多个时钟源呢？

STM32本身十分复杂，外设非常多 但我们实际使用的时候只会用到有限的几个外设，使用任何外设都需要时钟才能启动，但并不是所有的外设都需要系统时钟那么高的频率，为了兼容不同速度的设备，有些高速，有些低速，如果都用高速时钟，势必造成浪费  并且，同一个电路，时钟越快功耗越快，同时抗电磁干扰能力也就越弱，所以较为复杂的MCU都是采用多时钟源的方法来解决这些问题。

### STM32的时钟系统框图

<img src="https://i.postimg.cc/7YTQ3FpZ/STM32.png" alt="Image" data-zoomable width="80%;">

系统时钟有很多种选择，左边的部分就是设置系统时钟使用那个时钟源， 右边是系统时钟通过AHB预分频器，给相对应的外设设置相对应的时钟频率。从左到右可以简单理解为 各个时钟源--->系统时钟来源的设置--->各个外设时钟的设置。

### 时钟系统

#### 时钟源

STM32 有**4个**独立时钟源:HSI、HSE、LSI、LSE。

1. HSI是高速内部时钟，RC振荡器，频率为8MHz，精度不高。
2. HSE是高速外部时钟，可接石英/陶瓷谐振器，或者接外部时钟源，频率范围为**4MHz~16MHz**。
3. LSI是低速内部时钟，RC振荡器，频率为40kHz，提供低功耗时钟。　 
4. LSE是低速外部时钟，接频率为32.768kHz的石英晶体。

其中**LSI**是作为**IWDGCLK(独立看门狗)**时钟源和**RTC时钟源**而独立使用，而HSI高速内部时钟HSE高速外部时钟PLL锁相环时钟这三个经过分频或者倍频作为系统时钟来使用。

**PLL为锁相环倍频输出**，其时钟输入源可选择为**HSI/2、HSE或者HSE/2**。倍频可选择为**2~16**倍，但是其输出频率最大不得超过72MHz， 通过倍频之后作为系统时钟的时钟源。

比如Keil编写程序是默认的时钟为72Mhz，其实是这么来的：

- 外部晶振(**HSE**)提供的8MHz（与电路板上的晶振的相关）通过**PLLXTPRE分频器**后，进入**PLLSRC选择开关**，进而通过**PLLMUL锁相环**进行倍频（x9）后，为系统提供72MHz的系统时钟（SYSCLK）。之后是AHB预分频器对时钟信号进行分频，然后为低速外设提供时钟。
- **内部RC振荡器(HSI) 为**8MHz /2 为4MHz 进入**PLLSRC选择开关**，通过**PLLMUL锁相环**进行倍频（x18）后 为72MHz。

#### 输出时钟信号

STM32可以选择一个时钟信号输出到MCO脚(PA8)上，可以选择为PLL输出的2分频、HSI、HSE、或者系统时钟。可以把时钟信号输出供外部使用。

<img src="https://i.postimg.cc/RVRGLvg9/image.png" alt="Image" data-zoomable width="80%;">

#### USB时钟

STM32中有一个全速功能的USB模块，其串行接口引擎需要一个频率为48MHz的时钟源。该时钟源只能从PLL输出端获取（唯一的），可以选择为1.5分频或者1分频，当需要使用USB模块时，PLL必须使能，并且时钟频率配置为48MHz或72MHz。

<img src="https://i.postimg.cc/Bb3c2zDX/USB.png" alt="Image" data-zoomable width="80%;">



#### 外设时钟

**简单流程**：系统时钟--->AHB分频器--->各个外设分频倍频器 --->  外设时钟的设置。

右边部分为：**系统时钟SYSCLK通过AHB分频器分频后送给各模块使用**，AHB分频器可选择1、2、4、8、16、64、128、256、512分频。其中AHB分频器输出的时钟送给5大模块使用： 

1. **内核总线**：送给AHB总线、内核、内存和DMA使用的HCLK时钟。 
2. **Tick定时器**：通过8分频后送给Cortex的系统定时器时钟。 
3. **I2S总线**：直接送给Cortex的空闲运行时钟FCLK。 
4. **APB1外设**：送给APB1分频器。**APB1分频器可选择1、2、4、8、16分频**，其输出一路供APB1外设使用(PCLK1，最大频率36MHz)，另一路送给通用定时器使用。该倍频器可选择1或者2倍频，时钟输出供定时器2-7使用。 
5. **APB2外设**：送给APB2分频器。**APB2分频器可选择1、2、4、8、16分频**，其输出一路供APB2外设使用(PCLK2，最大频率72MHz)，另一路送给高级定时器。该倍频器可选择1或者2倍频，时钟输出供定时器1和定时器8使用。

另外，APB2分频器还有一路输出供ADC分频器使用，分频后送给ADC模块使用。ADC分频器可选择为2、4、6、8分频。 

需要注意的是，如果 APB 预分频器分频系数是1，则定时器时钟频率 (TIMxCLK) 为 PCLKx。否则定时器时钟频率将为APB域的频率的两倍：TIMxCLK = 2xPCLKx。 

<img src="https://i.postimg.cc/j5KN3FqN/APB1-APB2-F1.png" alt="Image" data-zoomable width="80%;">

## 参考资料

<a href="https://www.bilibili.com/video/BV1th411z7sn?p=13&vd_source=fcbd8c5e9a46fc8723685feb30801506" target="_blank">[6-1\] TIM定时中断_哔哩哔哩_bilibili</a>

<a href="https://blog.csdn.net/shun1296/article/details/121147491" target="_blank">基于stm32f103c8t6的定时器详解（持续更新）_stm32f103c8t6定时器-CSDN博客</a>

<a href="https://blog.csdn.net/qq_38410730/article/details/79976785" target="_blank">【STM32】通用定时器的基本原理（实例：定时器中断）_tim6具备位 16位可编程预分频器,时钟频率的分频系数为之间的任意数值</a>

<a href="https://blog.csdn.net/as480133937/article/details/98845509" target="_blank">【STM32】系统时钟RCC详解(超详细，超全面)_rcc时钟-CSDN博客</a>